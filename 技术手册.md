# 技术手册（系统化版）

本文档面向开发与运维人员，系统说明本项目的架构、数据流、关键模块、运行策略与排障方法。

---

## 1. 项目目标与总体架构

本项目是一个面向电力系统知识场景的 Graph-Enhanced RAG 系统，核心目标：

1. 支持多源文档（Markdown/PDF）统一入库。
2. 使用向量检索 + 知识图谱混合检索，提高召回与可解释性。
3. 使用本地模型（Ollama）完成：
   - PDF 多模态识别（默认 `qwen3-vl:8b`）
   - 实体关系抽取与答案生成（默认 `deepseek-r1:7b`）

系统主流程：

1. 文档预处理：PDF 按页转 Markdown，并保存中间页图。
2. 文本分块：对 Markdown 提取纯文本并中文分块。
3. 向量索引：将文本块编码后写入 FAISS。
4. 图谱构建：抽取实体/关系并构建有向图。
5. 在线问答：混合检索上下文 + LLM 生成答案。

---

## 2. 目录与关键文件

- `main.py`：启动入口、模型加载/重建判定、交互问答循环。
- `graph_rag.py`：核心流程（PDF 转换、分块、图谱、检索、生成）。
- `vector_store.py`：FAISS 向量索引封装。
- `data/`：知识源目录（`.md` / `.pdf`）。
- `data/figs/`：PDF 分页渲染中间图片产物。
- `model_files/`：持久化索引与图谱数据。

---

## 3. 文档处理模块（`DocumentProcessor`）

### 3.1 Markdown 处理

`process_markdown(file_path)`：

1. 读取 Markdown。
2. 转 HTML（`markdown` 库）。
3. 提取纯文本（`BeautifulSoup`）。
4. 标准化空白字符。
5. 调用 `_chinese_chunk` 按中文语义切块。

`_chinese_chunk(text, source)`：

- 使用 `jieba` 分词。
- 按 `。！？；` 等句末标点聚合句子。
- 控制单块长度（约 500 字）并保留来源。

### 3.2 PDF 处理入口

`convert_pdfs_to_markdown(data_dir)`：

- 扫描 `data_dir/*.pdf`。
- 使用分页输出策略：`<pdf_stem>_1.md ... <pdf_stem>_N.md`。
- 增量跳过：若分页 md 均存在且更新时间不早于 pdf，则跳过。
- 异常时输出类型、堆栈与排查建议。

---

## 4. PDF 多模态转换模块（`PDFToMarkdownConverter`）

### 4.1 按页转换策略

`convert(pdf_path, output_dir)` 逐页执行：

1. 渲染单页为 PNG。
2. 将 PNG 保存到 `data/figs/`。
3. base64 编码后调用 `ollama.chat`（多模态）识别。
4. 将识别结果落盘为当前页 Markdown。

输出文件：

- Markdown：`data/<pdf_stem>_<page>.md`
- 中间图：`data/figs/<pdf_stem>_<page>.png`

并会自动：

- 清理旧版整本 `data/<pdf_stem>.md`
- 清理超出当前页数的旧分页 md/png

### 4.2 公式与图片规则

模型提示词固定要求：

1. 公式必须转 LaTeX。
2. 独立公式使用 `$$...$$` 单独成行。
3. 行内公式使用 `$...$`。
4. 图片不输出链接，使用 `[图示说明：...]`。

### 4.3 LLM 交互日志与重试

每页处理会打印：

- 页进度日志（第 i/N 页）
- `[LLM请求]`（文件/页码/模型/keep_alive/prompt长度）
- `[LLM响应]`（返回长度/预览）
- `[LLM异常]`、`[LLM重试]`

重试策略：

- 识别 `503/timeout/temporarily` 为可重试错误。
- 默认重试 3 次，退避等待（`retry_wait_s * attempt`）。
- 若重试后仍失败，不中断整本：写入失败占位 Markdown 继续后续页。

### 4.4 显存控制策略

默认开启 `release_vram_each_page=True`：

- 调用 Ollama 时 `keep_alive=0s`
- 目标：每页后尽量释放模型驻留，降低长 PDF 连续处理显存峰值。

如追求速度可关闭（会提高驻留）：

- `release_vram_each_page=False`（内部将使用 `keep_alive=5m`）

---

## 5. 向量索引模块（`VectorStore`）

`vector_store.py` 封装 FAISS：

1. 初始化：`faiss.IndexFlatL2`。
2. 写入：`add_item` / `add_items`。
3. 检索：`search(query_vector, top_k)`。
4. 持久化：`save_index` / `load_index`（含 `id_to_chunk_id` 映射）。

说明：检索返回距离，业务层会映射为相似度分值用于排序融合。

---

## 6. 图谱模块（`GraphRAG`）

### 6.1 实体关系抽取

`extract_entities_and_relations(text)` 使用 Ollama 文本模型，要求 JSON 结构输出：

```json
{
  "entities": ["实体1", "实体2"],
  "relations": [["实体1", "关系", "实体2"]]
}
```

函数内包含：

- 输出清洗（截取 JSON 主体）
- 解析异常保护
- 实体/关系合法性过滤

### 6.2 图谱构建

`build_graph(all_chunks, force_rebuild)`：

- 以实体为节点。
- `entity -> chunk_id` 边表示“出现于文本块”。
- `subj -> obj` 边存储语义关系。
- 保存 `graph/node_embeddings/chunk_contents` 到 `graph_data.pkl`。

### 6.3 图谱检索与答案生成

- `search`：计算实体与 query 的向量相似度，回收关联 chunk 与关系。
- `generate_answer`：把检索上下文拼接后调用 LLM 输出答案。

---

## 7. 混合检索模块（`ImprovedGraphRAG`）

### 7.1 启动预处理

`prepare_documents()`：先执行 PDF -> 分页 Markdown。

### 7.2 过期判定

`models_are_stale()`：比较 `data/` 文档与 `model_files/` 时间戳，判定是否需重建。

### 7.3 建库流程

`process_documents()`：

1. 预处理 PDF。
2. 遍历全部 `.md` 做分块。
3. 编码写入向量索引。
4. 构建知识图谱。

### 7.4 检索融合

`hybrid_search(query)`：

1. 向量召回若干 chunk。
2. 沿图谱扩展实体与关系。
3. 分数融合排序，返回最终上下文。

---

## 8. 启动与运行流程（`main.py`）

1. 导入 `ImprovedGraphRAG`（依赖缺失时给安装提示）。
2. 调用 `prepare_documents()` 做 PDF 预处理。
3. 尝试加载已有索引/图谱。
4. 若 `models_are_stale()` 为真，则重建。
5. 进入问答循环：检索 -> 生成 -> 输出。

---

## 9. 模型配置建议

### 9.1 默认模型

- PDF 多模态识别：`qwen3-vl:8b`（默认）
- 实体关系抽取/答案：`deepseek-r1:7b`

### 9.2 资源不足时建议

1. 保持 `qwen3-vl:8b`（不要切 30b）。
2. 适当降低 `page_dpi`（如 180~200）。
3. 保持 `release_vram_each_page=True`。
4. 先小批量 PDF 验证流程，再全量处理。

---

## 10. 常见问题（FAQ）

### Q1：为什么看到 `UNEXPECTED`？

通常是底层模型权重加载报告中的兼容提示；若功能正常可先忽略。

### Q2：PDF 某页报 `503` 怎么办？

系统会自动重试；仍失败则写占位页并继续。建议检查：

- Ollama 服务是否稳定
- 模型是否已拉取且可用
- GPU/内存是否紧张

### Q3：为什么有时不会重新建库？

因为 `models_are_stale()` 使用文件时间戳判断；若数据未更新会复用已有索引与图谱。

---

## 11. 开发建议

1. 对 PDF 转换模块补充可配置参数（DPI、重试次数、日志级别）到外部配置。
2. 为 PDF 转换、图谱构建、混合检索增加单元测试与回归测试。
3. 将 LLM 调用抽象为 Provider 层，便于切换模型或服务端点。
4. 在大规模数据场景下可引入异步队列做离线预处理。

---

## 12. 版本演进摘要（本轮）

- 支持 PDF 按页输出 Markdown。
- 中间渲染图保存到 `data/figs/`。
- 增加逐页日志、LLM 请求/响应日志。
- 增加 503 等临时错误自动重试。
- 重试后仍失败时写占位页，不中断整本流程。
- 默认开启每页释放模型驻留（`keep_alive=0s`）降低显存压力。

